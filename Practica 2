-- Crear tabla de usuarios con contraseña hasheada
CREATE TABLE Usuarios (
    UsuarioID INT PRIMARY KEY,
    NombreUsuario NVARCHAR(50),
    ContraseñaHash VARBINARY(64)
);

-- Insertar una contraseña usando SHA-256
DECLARE @Contraseña NVARCHAR(100) = 'MiContraseñaSegura123';
INSERT INTO Usuarios (UsuarioID, NombreUsuario, ContraseñaHash)
VALUES (
    1,
    'usuario1',
    HASHBYTES('SHA2_256', CONVERT(VARBINARY(100), @Contraseña))
);

-- Verificar contraseña (ejemplo de comparación)
DECLARE @Intento NVARCHAR(100) = 'MiContraseñaSegura123';
SELECT *
FROM Usuarios
WHERE NombreUsuario = 'usuario1'
  AND ContraseñaHash = HASHBYTES('SHA2_256', CONVERT(VARBINARY(100), @Intento));
-- Crear tabla con contraseña cifrada
CREATE TABLE UsuariosSeguros (
    UsuarioID INT PRIMARY KEY,
    NombreUsuario NVARCHAR(50),
    ContraseñaCifrada VARBINARY(MAX)
);

-- Insertar una contraseña cifrada
DECLARE @FraseSecreta NVARCHAR(128) = 'MiFraseDeCifradoSegura';
DECLARE @Contraseña NVARCHAR(100) = 'Clave123!';
INSERT INTO UsuariosSeguros (UsuarioID, NombreUsuario, ContraseñaCifrada)
VALUES (
    1,
    'usuario2',
    EncryptByPassPhrase(@FraseSecreta, @Contraseña)
);

-- Recuperar la contraseña (solo si tienes la frase secreta)
DECLARE @FraseSecreta NVARCHAR(128) = 'MiFraseDeCifradoSegura';
SELECT 
    UsuarioID,
    NombreUsuario,
    CONVERT(NVARCHAR(100), DecryptByPassPhrase(@FraseSecreta, ContraseñaCifrada)) AS ContraseñaRecuperada
FROM UsuariosSeguros;
-- Crear tabla con salt y hash
CREATE TABLE UsuariosConSalt (
    UsuarioID INT PRIMARY KEY,
    NombreUsuario NVARCHAR(50),
    Salt NVARCHAR(50),
    ContraseñaHash VARBINARY(64)
);

-- Insertar una contraseña con salt
DECLARE @Contraseña NVARCHAR(100) = 'MiClaveUltraSegura!';
DECLARE @Salt NVARCHAR(50) = CONVERT(NVARCHAR(50), NEWID()); -- Genera un salt aleatorio
DECLARE @ContraseñaConSalt NVARCHAR(150) = @Contraseña + @Salt;

INSERT INTO UsuariosConSalt (UsuarioID, NombreUsuario, Salt, ContraseñaHash)
VALUES (
    1,
    'usuario3',
    @Salt,
    HASHBYTES('SHA2_256', CONVERT(VARBINARY(150), @ContraseñaConSalt))
);

-- Verificar contraseña
DECLARE @Intento NVARCHAR(100) = 'MiClaveUltraSegura!';
DECLARE @SaltObtenido NVARCHAR(50) = (SELECT Salt FROM UsuariosConSalt WHERE NombreUsuario = 'usuario3');
DECLARE @IntentoConSalt NVARCHAR(150) = @Intento + @SaltObtenido;

SELECT *
FROM UsuariosConSalt
WHERE NombreUsuario = 'usuario3'
  AND ContraseñaHash = HASHBYTES('SHA2_256', CONVERT(VARBINARY(150), @IntentoConSalt));
CREATE TABLE Vuelos (
    IdVuelo INT PRIMARY KEY,
    Matricula VARCHAR(10),
    TipoAeronave VARCHAR(30),
    Destino VARCHAR(50),
    Rumbo VARCHAR(50),
    FechaVuelo DATE,
    HoraLlegada DATETIME
);
CREATE PROCEDURE ObtenerEstadisticasVuelos
    @DestinoFiltro VARCHAR(50),
    @RumboFiltro VARCHAR(50),
    @FechaFiltro DATE
AS
BEGIN
    SET NOCOUNT ON;

    -- Grupo por destino
    SELECT 
        'Grupo por Destino' AS Grupo,
        TipoAeronave,
        COUNT(*) AS TotalVuelos,
        MIN(HoraLlegada) AS PrimerLlegada,
        MAX(HoraLlegada) AS UltimaLlegada,
        AVG(DATEDIFF(MINUTE, CAST(@FechaFiltro AS DATETIME), HoraLlegada)) AS PromedioMinutosDesdeMedianoche
    FROM Vuelos
    WHERE Destino = @DestinoFiltro AND FechaVuelo = @FechaFiltro
    GROUP BY TipoAeronave

    UNION ALL

    -- Grupo por rumbo
    SELECT 
        'Grupo por Rumbo' AS Grupo,
        TipoAeronave,
        COUNT(*) AS TotalVuelos,
        MIN(HoraLlegada) AS PrimerLlegada,
        MAX(HoraLlegada) AS UltimaLlegada,
        AVG(DATEDIFF(MINUTE, CAST(@FechaFiltro AS DATETIME), HoraLlegada)) AS PromedioMinutosDesdeMedianoche
    FROM Vuelos
    WHERE Rumbo = @RumboFiltro AND FechaVuelo = @FechaFiltro
    GROUP BY TipoAeronave;
END;
EXEC ObtenerEstadisticasVuelos 
    @DestinoFiltro = 'Iquitos',
    @RumboFiltro = 'Norte-Oeste',
    @FechaFiltro = '2025-10-25';
